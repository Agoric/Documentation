(window.webpackJsonp=window.webpackJsonp||[]).push([[47],{420:function(t,a,e){"use strict";e.r(a);var n=e(42),s=Object(n.a)({},(function(){var t=this,a=t.$createElement,e=t._self._c||a;return e("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[e("h1",{attrs:{id:"contract-requirements"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#contract-requirements"}},[t._v("#")]),t._v(" Contract Requirements")]),t._v(" "),e("Zoe-Version"),t._v(" "),e("p",[t._v("When writing a smart contract to run on Zoe, you need\nto know the proper format and other expectations.")]),t._v(" "),e("p",[t._v("A Zoe contract is a JavaScript file that can import other JavaScript\ncode, including:")]),t._v(" "),e("ul",[e("li",[e("a",{attrs:{href:"https://www.npmjs.com/package/@agoric/harden",target:"_blank",rel:"noopener noreferrer"}},[t._v("@agoric/harden"),e("OutboundLink")],1),t._v(": a package for recursively deep-freezing")]),t._v(" "),e("li",[e("a",{attrs:{href:"https://www.npmjs.com/package/@agoric/nat",target:"_blank",rel:"noopener noreferrer"}},[t._v("@agoric/nat"),e("OutboundLink")],1),t._v(": a package\nfor testing whether something is a natural number (natural numbers\nare recommended for currency-related programming in order to avoid\nrounding issues) and throwing if not.")]),t._v(" "),e("li",[e("a",{attrs:{href:"https://www.npmjs.com/package/@agoric/zoe",target:"_blank",rel:"noopener noreferrer"}},[t._v("@agoric/notifier"),e("OutboundLink")],1),t._v(": A package that provides updates through\nsmartly resolving promises rather than polling")]),t._v(" "),e("li",[e("a",{attrs:{href:"https://www.npmjs.com/package/@agoric/zoe",target:"_blank",rel:"noopener noreferrer"}},[t._v("@agoric/zoe"),e("OutboundLink")],1),t._v(": Zoe has\nhelpers that contracts can use by importing\n"),e("code",[t._v("@agoric/zoe/src/contractSupport/zoeHelpers")])])]),t._v(" "),e("p",[t._v("A Zoe contract will be bundled up, so you should feel free to divide\nyour contract into multiple files (perhaps putting helper functions in a\nseparate file, for example) and import them.")]),t._v(" "),e("p",[t._v("A Zoe contract needs to be able to run under "),e("a",{attrs:{href:"https://github.com/Agoric/ses-shim#secure-ecmascript-shim-ses-shim",target:"_blank",rel:"noopener noreferrer"}},[t._v("Agoric's SES"),e("OutboundLink")],1),t._v(". Some legacy\nJavaScript code is incompatible with SES, because SES freezes the\nJavaScript objects you start out with (the primordials, such as "),e("code",[t._v("Object")]),t._v("), and some legacy code tries to\nmutate these.")]),t._v(" "),e("p",[t._v("If you add this type annotation at the start of your contract code, TypeScript-aware tools\n(IDEs like vsCode and WebStorm) will warn about mismatches in parameters and return values\nin calls to "),e("code",[t._v("zcf")]),t._v(" methods.  Put this right before the start of your contract code.")]),t._v(" "),e("div",{staticClass:"language-js extra-class"},[e("pre",{pre:!0,attrs:{class:"language-js"}},[e("code",[e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/**\n * @type {ContractStartFn}\n */")]),t._v("\n")])])]),e("p",[t._v("Your contract code must export a function "),e("code",[t._v("start()")]),t._v(" as a non-default export. "),e("code",[t._v("zcf")]),t._v("\nis the Zoe Contract Facet and is the only argument provided to the contract.")]),t._v(" "),e("div",{staticClass:"language-js extra-class"},[e("pre",{pre:!0,attrs:{class:"language-js"}},[e("code",[e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token function-variable function"}},[t._v("start")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("zcf")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("...")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// your code here")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("harden")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" creatorFacet"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" creatorInvitation"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" publicFacet "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("harden")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("start"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("export")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" start "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),e("p",[t._v("The contract must return a record with any (or none) of the following:")]),t._v(" "),e("ul",[e("li",[e("code",[t._v("creatorFacet")]),t._v(": An object, usually with admin authority. It is only given to the entity\nthat calls "),e("code",[t._v("E(zoe).startInstance()")]),t._v("; i.e. the party that was the creator of the current\ncontract "),e("code",[t._v("instance")]),t._v(". It might create "),e("code",[t._v("invitations")]),t._v(" for other parties, or take actions that\nare unrelated to making offers.")]),t._v(" "),e("li",[e("code",[t._v("creatorInvitation")]),t._v(": A Zoe "),e("code",[t._v("invitation")]),t._v(" only given to the entity that\ncalls "),e("code",[t._v("E(zoe).startInstance()")]),t._v("; i.e. the party that was the creator of the current\ncontract "),e("code",[t._v("instance")]),t._v(". This is usually used when a party has to make an offer first,\nsuch as escrowing the underlying good for sale in an auction or covered call.")]),t._v(" "),e("li",[e("code",[t._v("publicFacet")]),t._v(": An object available through Zoe to anyone who knows the contract "),e("code",[t._v("instance")]),t._v(".\nUse the "),e("code",[t._v("publicFacet")]),t._v(" for general queries and actions, such as getting the current price\nor creating public "),e("code",[t._v("invitations")]),t._v(".")])]),t._v(" "),e("p",[t._v("The contract can contain arbitrary JavaScript code, but there are a few things you'll want\nto do in order to act as a contract, and interact with Zoe and zcf (the internal contract\nfacet).")]),t._v(" "),e("p",[t._v("For users to make offers, the contract has to include a handler with the\ncode for what to do when the "),e("code",[t._v("invitation")]),t._v(" is used to make an offer. This handler is passed\nto "),e("code",[t._v("zcf.makeInvitation()")]),t._v(", and the resulting "),e("code",[t._v("invitation")]),t._v(" is made available (using the\n"),e("code",[t._v("creatorFacet")]),t._v(", the "),e("code",[t._v("publicFacet")]),t._v(", or whatever makes sense for the particular contract.")]),t._v(" "),e("p",[t._v("For instance, AtomicSwap makes two "),e("code",[t._v("invitations")]),t._v(". The first is used to create the initial\noffer, so it defines the terms that the counterparty responds to. The second party\nneeds to make a matching offer, so there are more constraints.")]),t._v(" "),e("p",[t._v("Use "),e("code",[t._v("zcf.makeInvitation()")]),t._v(" to create the first party's "),e("code",[t._v("invitation")]),t._v(":")]),t._v(" "),e("div",{staticClass:"language-js extra-class"},[e("pre",{pre:!0,attrs:{class:"language-js"}},[e("code",[t._v("  "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" creatorInvitation "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" zcf"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("makeInvitation")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n    makeMatchingInvitation"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'firstOffer'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),e("p",[e("code",[t._v("makeMatchingInvitation()")]),t._v(" creates the second "),e("code",[t._v("invitation")]),t._v(".")]),t._v(" "),e("div",{staticClass:"language-js extra-class"},[e("pre",{pre:!0,attrs:{class:"language-js"}},[e("code",[t._v("    "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" matchingSeatInvitation "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" zcf"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("makeInvitation")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n      matchingSeatOfferHandler"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n      "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'matchOffer'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n      "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        asset"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" give"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Asset"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n        price"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" want"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Price"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n      "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),e("p",[t._v("The third argument (which is optional and wasn't needed for the first "),e("code",[t._v("invitation")]),t._v(") says\nthe counterparty has to offer an "),e("code",[t._v("amount")]),t._v(" matching the first party's "),e("code",[t._v("want.Price")]),t._v(",\nand should ask for the first party's "),e("code",[t._v("give.Asset")]),t._v(". The optional third argument to\n"),e("code",[t._v("makeInvitation()")]),t._v(" is included so the "),e("code",[t._v("invitation")]),t._v(" will contain the "),e("code",[t._v("terms")]),t._v(" so the "),e("code",[t._v("invitation")]),t._v("\nrecipient can rely on them.")]),t._v(" "),e("p",[t._v("The "),e("code",[t._v("matchingSeatOfferHandler")]),t._v(" for this very simple contract calls "),e("code",[t._v("swap()")]),t._v(", a helper for\nthe simple case that each party wants what the other offered. If the terms match, Zoe\ngives each the "),e("code",[t._v("payout")]),t._v(" they asked for, and closes out the contract. If the terms don't\nmatch, they each get back what they brought to the exchange, and it's still over.")]),t._v(" "),e("div",{staticClass:"language-js extra-class"},[e("pre",{pre:!0,attrs:{class:"language-js"}},[e("code",[t._v("    "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token function-variable function"}},[t._v("matchingSeatOfferHandler")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("matchingSeat")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" swapResult "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("swap")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("zcf"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" firstSeat"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" matchingSeat"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n      zcf"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("shutdown")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n      "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" swapResult"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),e("p",[t._v("If you study other contracts, you'll see they all have this basic format. Depending\non their goals, they may do additional bookkeeping, or try to find compatible terms\nbetween multiple offers, or create new assets to order.")]),t._v(" "),e("h2",{attrs:{id:"making-an-invitation"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#making-an-invitation"}},[t._v("#")]),t._v(" Making an Invitation")]),t._v(" "),e("p",[t._v("To create an invitation in the contract, use the Zoe Contract\nFacet method ("),e("router-link",{attrs:{to:"/zoe/api/zoe-contract-facet.html#zcf-makeinvitation-offerhook-customproperties"}},[e("code",[t._v("zcf.makeInvitation")])]),t._v(").")],1)],1)}),[],!1,null,null,null);a.default=s.exports}}]);