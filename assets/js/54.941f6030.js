(window.webpackJsonp=window.webpackJsonp||[]).push([[54],{451:function(e,t,a){"use strict";a.r(t);var n=a(44),s=Object(n.a)({},(function(){var e=this,t=e.$createElement,a=e._self._c||t;return a("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[a("h1",{attrs:{id:"endo-and-hardened-javascript-ses-programming-guide"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#endo-and-hardened-javascript-ses-programming-guide"}},[e._v("#")]),e._v(" Endo and Hardened JavaScript (SES) Programming Guide")]),e._v(" "),a("p",[e._v("This is a guide to programming with "),a("em",[e._v("Hardened JavaScript")]),e._v(" and "),a("em",[e._v("Endo")]),e._v(". It:")]),e._v(" "),a("ul",[a("li",[e._v("Shows what you can and cannot do with a Hardened JavaScript program.")]),e._v(" "),a("li",[e._v("Defines what SES, the Hardened JavaScript shim, is and does.")]),e._v(" "),a("li",[e._v("Provides background on why JavaScript functionality was added, removed, or changed.")]),e._v(" "),a("li",[e._v("Describes "),a("em",[e._v("realms")]),e._v(" and "),a("em",[e._v("compartments")]),e._v(".")]),e._v(" "),a("li",[e._v("Introduces Endo.")])]),e._v(" "),a("p",[e._v("This is intended for initial reading when starting to use or learn about Agoric. For\nthose knowledgeable about or experienced with Hardened JavaScript, see the\n"),a("RouterLink",{attrs:{to:"/guides/js-programming/ses/ses-reference.html"}},[e._v("Endo and Hardened JavaScript Programming Reference")]),e._v("\nfor to use Hardened JavaScript without much explanation.")],1),e._v(" "),a("h2",{attrs:{id:"what-is-hardened-javascript"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#what-is-hardened-javascript"}},[e._v("#")]),e._v(" What is Hardened JavaScript?")]),e._v(" "),a("p",[e._v("Hardened JavaScript:")]),e._v(" "),a("ul",[a("li",[e._v("Is a JavaScript runtime library for safely running third-party code.")]),e._v(" "),a("li",[e._v("Addresses JavaScript’s lack of internal security.\n"),a("ul",[a("li",[e._v("This is particularly significant because JavaScript applications\nuse and rely on third-party code (modules, packages, libraries,\nuser-provided code for extensions and plug-ins, etc.).")])])]),e._v(" "),a("li",[e._v("Enforces best practices by removing hazardous features such as global\nmutable state and lack of encapsulation in sloppy mode.")]),e._v(" "),a("li",[e._v('Is a safe deterministic subset of "strict mode" JavaScript.')]),e._v(" "),a("li",[e._v("Does not include any IO objects that provide\n"),a("a",{attrs:{href:"https://en.wikipedia.org/wiki/Ambient_authority",target:"_blank",rel:"noopener noreferrer"}},[a("em",[e._v("ambient authority")]),a("OutboundLink")],1),e._v(".")]),e._v(" "),a("li",[e._v("Removes non-determinism by modifying a few built-in objects.")]),e._v(" "),a("li",[e._v("Adds functionality to freeze and make immutable both built-in JavaScript\nobjects and program created objects and make them immutable.")]),e._v(" "),a("li",[e._v("Is (as SES) is a proposed extension to the JavaScript standard.")])]),e._v(" "),a("p",[e._v("Hardened JavaScript consists of three parts:")]),e._v(" "),a("ul",[a("li",[e._v("Lockdown is a function that irreversibly repairs and hardens an existing\nmutable JavaScript environment.")]),e._v(" "),a("li",[e._v("Harden is a function that makes interfaces tamper-proof, so objects can be\nshared between programs.")]),e._v(" "),a("li",[e._v("Compartment is a class that constructs isolated environments, with separate\nglobals and modules, but shared hardened primordials and limited access to\nother powerful objects in global scope.")])]),e._v(" "),a("h2",{attrs:{id:"what-is-ses"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#what-is-ses"}},[e._v("#")]),e._v(" What is SES?")]),e._v(" "),a("p",[e._v("SES is an old umbrella term for the Hardened JavaScript effort, and while we\nrefer to these specific features as Hardened JavaScript, the SES name lingers\nin a few places.")]),e._v(" "),a("p",[e._v("SES (as "),a("code",[e._v("ses")]),e._v(" in npm, the Node.js package registry) is the name of a JavaScript\nlibrary that implements the Hardened JavaScript, that works in most modern\nJavaScript engines.")]),e._v(" "),a("p",[e._v("The SES Strategy group is a\n"),a("a",{attrs:{href:"https://groups.google.com/g/ses-strategy",target:"_blank",rel:"noopener noreferrer"}},[e._v("community"),a("OutboundLink")],1),e._v(" of developers advocating\nand discussing security features for inclusion in JavaScript.")]),e._v(" "),a("p",[e._v("As 2021 closes at time of writing, the language proposals still bear the SES\nname, though that is likely to change.")]),e._v(" "),a("h2",{attrs:{id:"what-is-endo"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#what-is-endo"}},[e._v("#")]),e._v(" What is Endo?")]),e._v(" "),a("p",[e._v("What Node.js does for JavaScript, Endo does for Hardened JavaScript.\nEndo loads packages and modules in an ECMAScript module loader that isolates\nevery package, granting limited access to the host's resources.\nAgoric smart contracts are an example of Endo guest programs.")]),e._v(" "),a("h2",{attrs:{id:"the-hardened-javascript-story"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#the-hardened-javascript-story"}},[e._v("#")]),e._v(" The Hardened JavaScript story")]),e._v(" "),a("p",[e._v("JavaScript was created to let web surfers safely run programs from strangers.\nWeb pages put JavaScript programs in a "),a("em",[e._v("sandbox")]),e._v(" that restricts their abilities\nwhile maximizing utility.")]),e._v(" "),a("p",[e._v("This worked well until web applications started inviting multiple strangers\ninto the same sandbox. But they continued to depend on a security model where\nevery stranger had their own sandbox.")]),e._v(" "),a("p",[e._v("Meanwhile, server-side JavaScript applications imbued their sandbox with unbounded\nabilities and ran programs written by strangers. They were vulnerable\nto both their dependencies "),a("em",[e._v("and")]),e._v(" also the rarely reviewed dependencies of their dependencies.")]),e._v(" "),a("p",[e._v("Hardened JavaScript uses a finer grain security model, "),a("em",[e._v("Object Capabilities")]),e._v(" or "),a("em",[e._v("OCaps")]),e._v(".\nWith OCaps, many strangers can collaborate in a single sandbox, without risking them\nfrustrating, interfering, or conspiring with or against the user or each other.")]),e._v(" "),a("p",[e._v("To do this, the Lockdown function "),a("em",[e._v("hardens")]),e._v(" the entire surface of the\nJavaScript environment.\n"),a("em",[e._v("The only way a program can subvert or communicate with another program is to\nhave been expressly granted a reference to an object provided by that other program.")])]),e._v(" "),a("p",[e._v("Any programming environment fitting the OCaps model satisfies three requirements:")]),e._v(" "),a("ul",[a("li",[e._v("Any program can protect its invariants by hiding its own data and capabilities.")]),e._v(" "),a("li",[e._v("Power can only be exercised over something by having a reference to the\nobject providing that power, for example, a file system object. A\nreference to a powerful object is a "),a("em",[e._v("capability")]),e._v(".")]),e._v(" "),a("li",[e._v("The only way to get a capability is by being given one. For example, by receiving\none as an argument of a constructor or method.")])]),e._v(" "),a("p",[e._v("Ordinary JavaScript does not fully qualify as an OCaps language due to the pervasive\nmutability of shared objects. You can construct a JavaScript subset with a\ntransitively immutable environment without any unintended capabilities. Starting\nin 2007 with ECMAScript 5, Agoric engineers and the OCap community have influenced\nJavaScript’s evolution so a program can transform its own environment into\nthis safe JavaScript environment.")]),e._v(" "),a("p",[e._v("As of February 2021, Hardened JavaScript (under the name SES) is making its way\nthrough JavaScript standards committees.\nIt is expected to become official JavaScript when the standards process\nis completed.\nMeanwhile, Agoric provides its own SES "),a("em",[e._v("shim")]),e._v(" (a library providing\nthe needed Hardened JavaScript features) for writing secure smart contracts in\nJavaScript.\nSeveral Agoric engineers are on the relevant standards committees\nand are responsible for aspects of Hardened JavaScript, so our SES should be\nvery close to the eventual standards.")]),e._v(" "),a("h2",{attrs:{id:"using-hardened-javascript-with-your-code"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#using-hardened-javascript-with-your-code"}},[e._v("#")]),e._v(" Using Hardened JavaScript with your code")]),e._v(" "),a("p",[e._v("The Lockdown function transforms ordinary JavaScript environments into Hardened\nJavaScript environments.")]),e._v(" "),a("p",[e._v("On Node.js you can import or require "),a("code",[e._v("ses")]),e._v(" in either CommonJS or ECMAScript\nmodules, then call "),a("code",[e._v("lockdown()")]),e._v(". This is a "),a("em",[e._v("shim")]),e._v(". It mutates the environment\nin place so any code running after the shim can assume it’s running in a hardened\nenvironment. This includes the globals "),a("code",[e._v("lockdown()")]),e._v(", "),a("code",[e._v("harden()")]),e._v(", "),a("code",[e._v("Compartment")]),e._v(",\nand so on. For example:")]),e._v(" "),a("div",{staticClass:"language-js extra-class"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[e._v("require")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[e._v('"ses"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[e._v("lockdown")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n")])])]),a("p",[e._v("Or:")]),e._v(" "),a("div",{staticClass:"language-js extra-class"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("import")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[e._v("'ses'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[e._v("lockdown")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n")])])]),a("p",[e._v("To ensure a module runs in a hardened environment, wrap the above code in a "),a("code",[e._v("ses-lockdown.js")]),e._v(" module and import it:")]),e._v(" "),a("div",{staticClass:"language-js extra-class"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("import")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[e._v("'./non-ses-code-before-lockdown.js'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("import")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[e._v("'./ses-lockdown.js'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[e._v("// calls lockdown.")]),e._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("import")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[e._v("'./ses-code-after-lockdown.js'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n")])])]),a("p",[e._v("To use SES as a script on the web, use the UMD build.")]),e._v(" "),a("div",{staticClass:"language-js extra-class"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("<")]),e._v("script src"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[e._v('"node_modules/ses/dist/ses.umd.min.js"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v(">")]),e._v("\n")])])]),a("h2",{attrs:{id:"what-lockdown-does-to-javascript"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#what-lockdown-does-to-javascript"}},[e._v("#")]),e._v(" What Lockdown does to JavaScript")]),e._v(" "),a("p",[e._v('Hardened JavaScript does not include any I/O objects providing "unsafe" '),a("a",{attrs:{href:"https://en.wikipedia.org/wiki/Ambient_authority",target:"_blank",rel:"noopener noreferrer"}},[a("em",[e._v("ambient authority")]),a("OutboundLink")],1),e._v(".\nIt also doesn't allow non-determinism from built-in JavaScript objects.")]),e._v(" "),a("p",[e._v("As of SES-0.8.0/Fall 2020, "),a("a",{attrs:{href:"https://github.com/endojs/endo/blob/SES-v0.8.0/packages/ses/src/whitelist.js",target:"_blank",rel:"noopener noreferrer"}},[e._v("Agoric's SES source code"),a("OutboundLink")],1),e._v("\ndefines a subset of the globals defined by the baseline JavaScript language specification. SES includes these globals:")]),e._v(" "),a("ul",[a("li",[a("code",[e._v("Object")])]),e._v(" "),a("li",[a("code",[e._v("Array")])]),e._v(" "),a("li",[a("code",[e._v("Number")])]),e._v(" "),a("li",[a("code",[e._v("Map")])]),e._v(" "),a("li",[a("code",[e._v("WeakMap")])]),e._v(" "),a("li",[a("code",[e._v("Number")])]),e._v(" "),a("li",[a("code",[e._v("BigInt")])]),e._v(" "),a("li",[a("code",[e._v("Intl")])]),e._v(" "),a("li",[a("code",[e._v("Math")]),e._v(" all features except\n"),a("ul",[a("li",[a("code",[e._v("Math.random()")]),e._v(" is disabled (calling it throws an error) as an obvious source of\nnon-determinism.")])])]),e._v(" "),a("li",[a("code",[e._v("Date")]),e._v(" all features except\n"),a("ul",[a("li",[a("code",[e._v("Date.now()")]),e._v(" returns "),a("code",[e._v("NaN")])]),e._v(" "),a("li",[a("code",[e._v("new Date(nonNumber)")]),e._v(" or "),a("code",[e._v("Date(anything)")]),e._v(" return a "),a("code",[e._v("Date")]),e._v(" that stringifies to "),a("code",[e._v('"Invalid Date"')])])])])]),e._v(" "),a("p",[e._v("Much of the "),a("code",[e._v("Intl")]),e._v(" package, and some other objects' locale-specific aspects (e.g. "),a("code",[e._v("Number.prototype.toLocaleString")]),e._v(")\nhave results that depend upon which locale is configured. This varies from one process to another.\nSee "),a("RouterLink",{attrs:{to:"/guides/js-programming/ses/lockdown.html"}},[a("code",[e._v("lockdown()")])]),e._v(" for how those are handled.")],1),e._v(" "),a("p",[e._v("Lockdown freezes "),a("em",[e._v("primordials")]),e._v("; built-in JavaScript objects such as "),a("code",[e._v("Object")]),e._v(", "),a("code",[e._v("Array")]),e._v(", and "),a("code",[e._v("RegExp")]),e._v(",\nand their prototype chains. "),a("code",[e._v("globalThis")]),e._v(" is also frozen. This prevents malicious code from changing their behavior\n(imagine "),a("code",[e._v("Array.prototype.push")]),e._v(" delivering a copy of its argument to an attacker, or ignoring\ncertain values). It also prevents using, for example, "),a("code",[e._v("Object.heyBuddy")]),e._v(" or "),a("code",[e._v("globalThis.heyBuddy")]),e._v("\nas an ambient communication channel via setting a property and another program periodically reading it.\nThis would violate object-capability discipline; objects may only communicate through references.")]),e._v(" "),a("p",[e._v("Both frozen primordials and a frozen "),a("code",[e._v("globalThis")]),e._v(" have problems with a few JavaScript\nlibraries that add new features to built-in objects (shims/polyfills). These\nlibraries stretch best practices' boundaries by adding new features to built-in\nobjects in a way Compartments don't allow.")]),e._v(" "),a("h2",{attrs:{id:"what-lockdown-removes-from-standard-javascript"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#what-lockdown-removes-from-standard-javascript"}},[e._v("#")]),e._v(" What Lockdown removes from standard JavaScript")]),e._v(" "),a("p",[e._v("Almost all existing JavaScript code runs under Node.js or inside a browser, so\nit's easy to conflate environment features with JavaScript. For example, you may\nbe surprised that "),a("code",[e._v("Buffer")]),e._v(" and "),a("code",[e._v("require")]),e._v(" are Node.js additions. Also "),a("code",[e._v("setTimeout()")]),e._v(",\n"),a("code",[e._v("setInterval()")]),e._v(", "),a("code",[e._v("URL")]),e._v(", "),a("code",[e._v("atob()")]),e._v(", "),a("code",[e._v("btoa()")]),e._v(", "),a("code",[e._v("TextEncoder")]),e._v(", and "),a("code",[e._v("TextDecoder")]),e._v(" are additions\nto the programming environment standardized by the web, and are not intrinsic\nto JavaScript.")]),e._v(" "),a("p",[e._v("Most Node.js-specific "),a("a",{attrs:{href:"https://nodejs.org/dist/latest-v14.x/docs/api/globals.html",target:"_blank",rel:"noopener noreferrer"}},[e._v("global objects"),a("OutboundLink")],1),e._v(" are\n"),a("strong",[e._v("unavailable")]),e._v(" including:")]),e._v(" "),a("ul",[a("li",[a("code",[e._v("queueMicrotask")])]),e._v(" "),a("li",[a("code",[e._v("URL")]),e._v(" and "),a("code",[e._v("URLSearchParams")])]),e._v(" "),a("li",[a("code",[e._v("WebAssembly")])]),e._v(" "),a("li",[a("code",[e._v("TextEncoder")]),e._v(" and "),a("code",[e._v("TextDecoder")])]),e._v(" "),a("li",[a("code",[e._v("global")]),e._v(" "),a("ul",[a("li",[e._v("Use "),a("code",[e._v("globalThis")]),e._v(" instead (and remember it is frozen).")])])]),e._v(" "),a("li",[a("code",[e._v("process")]),e._v(" "),a("ul",[a("li",[e._v("No "),a("code",[e._v("process.env")]),e._v(" to access the process's environment variables.")]),e._v(" "),a("li",[e._v("No "),a("code",[e._v("process.argv")]),e._v(" for the argument array.")])])]),e._v(" "),a("li",[a("code",[e._v("Buffer")]),e._v(" (consider using "),a("code",[e._v("TypedArray")]),e._v(" instead, but see below)")]),e._v(" "),a("li",[a("code",[e._v("setImmediate")]),e._v("/"),a("code",[e._v("clearImmediate")]),e._v(" "),a("ul",[a("li",[a("p",[e._v("You can generally replace "),a("code",[e._v("setImmediate(fn)")]),e._v("\nwith "),a("code",[e._v("Promise.resolve().then(_ => fn())")]),e._v(" to defer execution of "),a("code",[e._v("fn")]),e._v(" until after the current event/callback\nfinishes processing. But it won't run until after all "),a("em",[e._v("other")]),e._v(" ready Promise callbacks execute.")]),e._v(" "),a("p",[e._v("There are two queues: the "),a("em",[e._v("IO queue")]),e._v(" (accessed by "),a("code",[e._v("setImmediate")]),e._v("), and the "),a("em",[e._v("Promise queue")]),e._v(" (accessed by\nPromise resolution). Hardened JavaScript code can add to the Promise queue, but needs to be given a\ncapability to be able to add to the I/O queue. Note that the Promise queue is\nhigher-priority than the IO queue, so the Promise queue must be empty for any IO or timers to be handled.")])])])]),e._v(" "),a("li",[a("code",[e._v("setInterval")]),e._v(" and "),a("code",[e._v("setTimeout")]),e._v(" (and "),a("code",[e._v("clearInterval")]),e._v("/"),a("code",[e._v("clearTimeout")]),e._v(")\n"),a("ul",[a("li",[e._v("Any notion of time must come from\nexchanging messages with external timer services (the SwingSet environment provides a "),a("code",[e._v("TimerService")]),e._v(" object\nto the bootstrap vat, which can share it with other vats)")])])])]),e._v(" "),a("p",[e._v("None of the huge list of "),a("a",{attrs:{href:"https://developer.mozilla.org/en-US/docs/Web/API",target:"_blank",rel:"noopener noreferrer"}},[e._v("other Browser environment features"),a("OutboundLink")],1),e._v("\npresented as names in the global scope (some also added to Node.js) are available in a\nhardened environment. The most surprising removals include "),a("code",[e._v("atob")]),e._v(", "),a("code",[e._v("TextEncoder")]),e._v(", and "),a("code",[e._v("URL")]),e._v(".")]),e._v(" "),a("p",[a("code",[e._v("debugger")]),e._v(" is a first-class JavaScript statement, and behaves as expected.")]),e._v(" "),a("h2",{attrs:{id:"what-hardened-javascript-adds-to-standard-javascript"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#what-hardened-javascript-adds-to-standard-javascript"}},[e._v("#")]),e._v(" What Hardened JavaScript adds to standard Javascript")]),e._v(" "),a("p",[e._v("The following anticipate additional proposed standard-track features. If they become standards,\nfuture JavaScript environments will include them as global objects. So the current Agoric SES shim\nmakes those global objects available.")]),e._v(" "),a("ul",[a("li",[a("p",[a("code",[e._v("console")]),e._v(" is available for debugging. While not in the official spec, since all implementations\nadd it, leaving it out would cause confusion. Note that "),a("code",[e._v("console.log")]),e._v("’s exact\nbehavior is up to the host program; display to the operator is not guaranteed. Use the\nconsole for debug information only. The console is not obliged to write to the POSIX standard output.")])]),e._v(" "),a("li",[a("p",[a("code",[e._v("assert")]),e._v(" is also a debugging tool that allows programs to express assertions\nand defer the construction of error objects and computed messages until an\nassertion fails.")])]),e._v(" "),a("li",[a("p",[a("code",[e._v("lockdown()")]),e._v(" and "),a("code",[e._v("harden()")]),e._v(" both freeze an object’s API surface (enumerable data properties).\nA hardened object’s properties cannot be changed, only read, so the only way to interact with a\nhardened object is through its methods. "),a("code",[e._v("harden()")]),e._v(" is similar to "),a("code",[e._v("Object.freeze()")]),e._v(" but more\nthorough. See the individual "),a("a",{attrs:{href:"#lockdown"}},[a("code",[e._v("lockdown()")])]),e._v(" and "),a("a",{attrs:{href:"#harden"}},[a("code",[e._v("harden()")])]),e._v(" sections\nbelow.")])]),e._v(" "),a("li",[a("p",[a("code",[e._v("[Compartment](https://github.com/endojs/endo/tree/SES-v0.8.0/packages/ses#compartment)")]),e._v(" is\na global. Code runs inside a "),a("code",[e._v("Compartment")]),e._v(" and can create sub-compartments to host other\ncode (with different globals or transforms). Note that these child compartments get "),a("code",[e._v("harden()")]),e._v(" and "),a("code",[e._v("Compartment")]),e._v(".")])])]),e._v(" "),a("h2",{attrs:{id:"realms"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#realms"}},[e._v("#")]),e._v(" Realms")]),e._v(" "),a("p",[e._v("Agoric deploy scripts and smart contract code run in an "),a("em",[e._v("immutable\nrealm")]),e._v(" with "),a("em",[e._v("Compartments")]),e._v(" providing just enough authority to create\nuseful and secure contracts. But not enough authority to do anything\nunintended or harmful to the participants of the smart contract.")]),e._v(" "),a("p",[e._v("JavaScript code runs in the context of\na "),a("a",{attrs:{href:"https://www.ecma-international.org/ecma-262/10.0/index.html#sec-code-realms",target:"_blank",rel:"noopener noreferrer"}},[a("em",[e._v("Realm")]),a("OutboundLink")],1),e._v(". A\nrealm is the set of "),a("em",[e._v("primordials")]),e._v(" (objects and standard library functions\nlike "),a("code",[e._v("Array.prototype.push")]),e._v(") and a global object. In a web browser, an iframe is a realm.\nIn Node.js, a Node process is a realm.")]),e._v(" "),a("p",[e._v("For historical reasons, the ECMAScript specification requires primordials\nbe mutable ("),a("code",[e._v("Array.prototype.push = yourFunction")]),e._v(" is valid ECMAScript but not\nrecommended). By using the Agoric SES shim and calling "),a("code",[e._v("lockdown()")]),e._v(", you can turn the\ncurrent realm into an "),a("em",[e._v("immutable realm")]),e._v("; a realm within which the primordials\nare deeply frozen.")]),e._v(" "),a("p",[e._v("SES also lets programs create "),a("em",[e._v("Compartments")]),e._v('. These are "mini-realms".\nA Compartment has its own dedicated global object and environment, but\nit inherits the primordials from their parent realm. Components are described\nin detail in the next section.')]),e._v(" "),a("h2",{attrs:{id:"compartments"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#compartments"}},[e._v("#")]),e._v(" Compartments")]),e._v(" "),a("p",[e._v("A "),a("em",[e._v("compartment")]),e._v(" is an execution environment for evaluating a stranger’s code. It has\nits own "),a("code",[e._v("globalThis")]),e._v(" global object and wholly independent system of\nmodules. Otherwise it shares the same batch of intrinsics such as "),a("code",[e._v("Array")]),e._v(" with its surrounding\ncompartment. The concept of a compartment implies an initial compartment,\nthe initial execution environment of a realm. After lockdown is called, all compartments share the same\nfrozen realm.")]),e._v(" "),a("p",[e._v("Here we create a compartment with a "),a("code",[e._v("print()")]),e._v(" function on "),a("code",[e._v("globalThis")]),e._v(".")]),e._v(" "),a("div",{staticClass:"language-js extra-class"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("import")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[e._v("'ses'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("const")]),e._v(" c "),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("new")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[e._v("Compartment")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("\n  print"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[e._v("harden")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),e._v("console"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),e._v("log"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n\nc"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[e._v("evaluate")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),a("span",{pre:!0,attrs:{class:"token template-string"}},[a("span",{pre:!0,attrs:{class:"token template-punctuation string"}},[e._v("`")]),a("span",{pre:!0,attrs:{class:"token string"}},[e._v("\n  print('Hello! Hello?');\n")]),a("span",{pre:!0,attrs:{class:"token template-punctuation string"}},[e._v("`")])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n")])])]),a("p",[e._v("This new compartment has a different global object than the start compartment. We\nposit that all JavaScript executes in a realm and compartment. Every realm has\ndistinct intrinsics, whereas every compartment shares intrinsics. The initial\nrealm and compartment are not constructed with "),a("code",[e._v("new Realm()")]),e._v(" or "),a("code",[e._v("new Compartment()")]),e._v(" but\nthat’s invisible to the code running; they could just as well be running within\na constructed realm or compartment.")]),e._v(" "),a("p",[e._v("We call the one compartment in a realm that was not expressly constructed the start\ncompartment. The start compartment receives some ambient authorities from the host,\noften access to timers and IO that are denied to other compartments. Running lockdown\ndoes not erase these powerful objects, but puts the program running in the start\ncompartment on a footing where it is possible to carefully delegate powers to child\ncompartments.")]),e._v(" "),a("p",[e._v("The global object is initially mutable. Locking down the realm hardened the objects in\nglobal scope. After lockdown, no compartment can tamper with these intrinsics and\nundeniable objects. Many of these are identical in the new compartment.")]),e._v(" "),a("div",{staticClass:"language-js extra-class"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("const")]),e._v(" c "),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("new")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[e._v("Compartment")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\nc"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),e._v("globalThis "),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("===")]),e._v(" globalThis"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[e._v("// false")]),e._v("\nc"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),e._v("globalThis"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),a("span",{pre:!0,attrs:{class:"token constant"}},[e._v("JSON")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("===")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token constant"}},[e._v("JSON")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[e._v("// true")]),e._v("\n")])])]),a("p",[e._v("Other pairs of compartments also share many identical intrinsics and undeniable objects\nof the realm. Each has a unique, initially mutable, global object.")]),e._v(" "),a("div",{staticClass:"language-js extra-class"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("const")]),e._v(" c1 "),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("new")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[e._v("Compartment")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("const")]),e._v(" c2 "),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("new")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[e._v("Compartment")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\nc1"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),e._v("globalThis "),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("===")]),e._v(" c2"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),e._v("globalThis"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[e._v("// false")]),e._v("\nc1"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),e._v("globalThis"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),a("span",{pre:!0,attrs:{class:"token constant"}},[e._v("JSON")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("===")]),e._v(" c2"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),e._v("globalThis"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),a("span",{pre:!0,attrs:{class:"token constant"}},[e._v("JSON")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[e._v("// true")]),e._v("\n")])])]),a("p",[e._v("Every compartment's global scope includes a shallow, specialized copy of the JavaScript\nintrinsics. These omit "),a("code",[e._v("Date.now()")]),e._v(" and "),a("code",[e._v("Math.random()")]),e._v("\nsince they can be covert inter-program communication channels.")]),e._v(" "),a("p",[e._v("However, a compartment may be expressly given access to these objects through\nthe compartment constructor's first argument or by assigning them to the\ncompartment's "),a("code",[e._v("globalThis")]),e._v(" after construction.")]),e._v(" "),a("div",{staticClass:"language-js extra-class"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("const")]),e._v(" powerfulCompartment "),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("new")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[e._v("Compartment")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v(" Math "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\npowerfulCompartment"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),e._v("globalThis"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),e._v("Date "),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v(" Date"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n")])])]),a("p",[e._v("When you create a new "),a("code",[e._v("Compartment")]),e._v(" object, you must decide if it supports OCaps security.\nIf it does, run "),a("code",[e._v("harden(compartment.globalThis)")]),e._v(" on it before loading any untrusted code into it.")]),e._v(" "),a("p",[e._v("A single compartment can run a JavaScript program in the locked-down environment.\nHowever, most interesting programs have multiple modules. So, each compartment also has\nits own module system. SES version 0.8.0 adds support for ECMAScript modules,\na relatively new system supported by many browsers, and officially released in Node.js 14.")]),e._v(" "),a("p",[e._v("Compartments can be linked, so one compartment can export a module that another compartment\nimports. Each compartment may have its own rules for how to resolve import specifiers and\nhow to locate and retrieve modules. In the following example, we use the compartment constructor to\ncreate two compartments: one for the application and another for its dependency.")]),e._v(" "),a("p",[e._v("The "),a("code",[e._v("resolveHook")]),e._v(" is synchronous and determines how to compute the full module specifier\nfor a partially resolved module specifier in ESM source text, like "),a("code",[e._v('import "./even.js"')]),e._v(" as\nit appears in "),a("code",[e._v("./math/odd.js")]),e._v(" corresponds to "),a("code",[e._v("./math/even.js")]),e._v(" in a Node.js program.")]),e._v(" "),a("p",[e._v("The "),a("code",[e._v("importHook")]),e._v(" is asynchronous and responsible for for locating, retrieving, and parsing\nmodules. Retrieving is getting the source text from the web, archive, or database based on\nits location. Converting a module specifier to a location is an internal concern of\nthe "),a("code",[e._v("importHook")]),e._v(" and the particular storage medium for the module texts, but should generally\nbe a URL and may appear in stack traces. The "),a("code",[e._v("importHook")]),e._v(" may use the "),a("code",[e._v("ModuleStaticRecord")]),e._v("\nconstructor to create a reusable, parsed representation of the module text.")]),e._v(" "),a("div",{staticClass:"language-js extra-class"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("const")]),e._v(" dependency "),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("new")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[e._v("Compartment")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("\n  "),a("span",{pre:!0,attrs:{class:"token function-variable function"}},[e._v("resolveHook")]),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),a("span",{pre:!0,attrs:{class:"token parameter"}},[e._v("moduleSpecifier"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v(" moduleReferrer")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=>")]),e._v("\n    "),a("span",{pre:!0,attrs:{class:"token function"}},[e._v("resolve")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),e._v("moduleSpecifier"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v(" moduleReferrer"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v("\n  "),a("span",{pre:!0,attrs:{class:"token function-variable function"}},[e._v("importHook")]),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("async")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token parameter"}},[e._v("moduleSpecifier")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=>")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("const")]),e._v(" moduleLocation "),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[e._v("locate")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),e._v("moduleSpecifier"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("const")]),e._v(" moduleText "),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("await")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[e._v("retrieve")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),e._v("moduleLocation"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("return")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("new")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[e._v("ModuleStaticRecord")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),e._v("moduleText"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v(" moduleLocation"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("const")]),e._v(" application "),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("new")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[e._v("Compartment")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("\n  "),a("span",{pre:!0,attrs:{class:"token string"}},[e._v("'dependency'")]),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),e._v(" dependency"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[e._v("module")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[e._v("'./main.js'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("\n  resolveHook"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v("\n  importHook"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n")])])]),a("p",[e._v("Compartments provide a low-level loader API for JavaScript modules.\nYour code might run in compartments, but they are an implementation\ndetail of tools and runtimes.")]),e._v(" "),a("p",[e._v("Vats in the Agoric runtime use compartments to isolate contracts within a vat.\nA vat can use multiple compartments.\nMetaMask’s LavaMoat uses a Compartment for every module, to create\nboundaries between application code and third-party dependencies.")]),e._v(" "),a("p",[e._v("The lifetime of a compartment is bounded by garbage collection and the\nlifetime of the realm that contains them. You will not ever have to tear\ndown or delete one.")]),e._v(" "),a("h2",{attrs:{id:"lockdown"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#lockdown"}},[e._v("#")]),e._v(" "),a("code",[e._v("lockdown()")])]),e._v(" "),a("p",[a("code",[e._v("lockdown()")]),e._v(" freezes all JavaScript defined objects accessible to any\nprogram in the execution environment. Calling "),a("code",[e._v("lockdown()")]),e._v(" turns a JavaScript\nsystem into a hardened system, with enforced OCap (object-capability) security. It\nalters the surrounding execution environment (realm) such that no two\nprograms running in the same realm can observe or interfere with each other\nuntil they have been introduced.")]),e._v(" "),a("p",[e._v("To do this, "),a("code",[e._v("lockdown()")]),e._v(" tamper-proofs all of the JavaScript intrinsics to prevent\nprototype pollution. After that, no program can subvert the methods of these objects\n(preventing some man in the middle attacks). Also, no program can use these mutable\nobjects to pass notes to parties that haven't been expressly introduced (preventing\nsome covert communication channels).")]),e._v(" "),a("p",[e._v("For a full explanation of "),a("code",[e._v("lockdown()")]),e._v(" and its options, please click\n"),a("RouterLink",{attrs:{to:"/guides/js-programming/ses/lockdown.html"}},[e._v("here")]),e._v(".")],1),e._v(" "),a("h2",{attrs:{id:"harden"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#harden"}},[e._v("#")]),e._v(" "),a("code",[e._v("harden()")])]),e._v(" "),a("p",[a("code",[e._v("harden()")]),e._v(" is automatically provided by "),a("code",[e._v("lockdown()")]),e._v(". Any code that will run inside a vat or a\ncontract can use harden as a global, without importing anything. The Agoric programming\nenvironment defines objects ("),a("code",[e._v("mint")]),e._v(", "),a("code",[e._v("issuer")]),e._v(", "),a("code",[e._v("zcf")]),e._v(", etc.) that shouldn't need hardening\nas their constructors do that work. You mainly need to harden records, callbacks, and ephemeral objects.")]),e._v(" "),a("p",[a("code",[e._v("harden()")]),e._v(" must be called on all objects that will be transferred across a trust boundary\nThe general rule is if you make a new object and give it to someone else (and don't\nimmediately forget it yourself), you should give them "),a("code",[e._v("harden(obj)")]),e._v(" instead of the raw object.\nThis ensures other objects can only interact with them through their defined method interface,\ni.e. the functions in the object's API. "),a("em",[e._v("CapTP")]),e._v(", our communications layer for passing\nreferences to distributed objects, enforces this at vat boundaries.")]),e._v(" "),a("p",[e._v("Hardening an instance also hardens its class.")]),e._v(" "),a("p",[e._v("You can send a message to a hardened object. If it's a record, you can access\nits properties and their values. Being hardened doesn't preclude an object from having\naccess to mutable state ("),a("code",[e._v("harden(new Map())")]),e._v(" still behaves like a normal mutable "),a("code",[e._v("Map")]),e._v("),\nbut it means their methods stay the same and can't be surprisingly changed by someone else.")]),e._v(" "),a("blockquote",[a("p",[e._v("Tip: If your text editor/IDE complains about "),a("code",[e._v("harden()")]),e._v(" not being defined or imported,\ntry adding "),a("code",[e._v("/* global harden */")]),e._v(" to the top of the file.")]),e._v(" "),a("p",[e._v("You use "),a("code",[e._v("harden()")]),e._v(" like this:")]),e._v(" "),a("div",{staticClass:"language-js extra-class"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("const")]),e._v(" o "),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("a"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[e._v("2")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\no"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),e._v("a  "),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[e._v("12")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\nconsole"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[e._v("log")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),e._v("o"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),e._v("a"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[e._v("// 12 because o is still mutable")]),e._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[e._v("harden")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),e._v("o"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\no"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),e._v("a  "),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[e._v("37")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[e._v("// throws a TypeError because o is now hardened")]),e._v("\n")])])])]),e._v(" "),a("h2",{attrs:{id:"lockdown-and-harden"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#lockdown-and-harden"}},[e._v("#")]),e._v(" "),a("code",[e._v("lockdown()")]),e._v(" and "),a("code",[e._v("harden()")])]),e._v(" "),a("p",[a("code",[e._v("lockdown()")]),e._v(" and "),a("code",[e._v("harden()")]),e._v(" essentially do the same thing; freeze objects so their\nproperties cannot be changed. The only way to interact with frozen objects is through\ntheir methods. Their differences are what objects you use them on, and when you use them.")]),e._v(" "),a("p",[a("code",[e._v("lockdown()")]),e._v(" "),a("strong",[e._v("must")]),e._v(" be called first. It hardens JavaScript's built-in "),a("em",[e._v("primordials")]),e._v("\n(implicitly shared global objects) and enables "),a("code",[e._v("harden()")]),e._v(". If you call "),a("code",[e._v("harden()")]),e._v("\nbefore "),a("code",[e._v("lockdown()")]),e._v(" executes, it throws an error.")]),e._v(" "),a("p",[a("code",[e._v("lockdown()")]),e._v(" works on objects created by the JavaScript language itself as part of\nits definition. Use "),a("code",[e._v("harden()")]),e._v(" to freeze objects created after "),a("code",[e._v("lockdown()")]),e._v("was called;\ni.e. objects created by programs written in JavaScript.")]),e._v(" "),a("h2",{attrs:{id:"library-compatibility"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#library-compatibility"}},[e._v("#")]),e._v(" Library compatibility")]),e._v(" "),a("p",[e._v("Programs running under SES can use "),a("code",[e._v("import")]),e._v(" or "),a("code",[e._v("require()")]),e._v(" to import other libraries consisting\nonly of SES-compatible JavaScript code. This includes a significant part of the NPM registry.")]),e._v(" "),a("p",[e._v("However, many NPM packages use built-in Node.js modules. If used at import time (in their top-level\ncode), hardened JavaScript code cannot use the package and fails to load at all. If they use the built-in\nfeatures at runtime, then the package can load. However, it might fail later when an invoked function\naccesses the missing functionality. So some NPM packages are partially compatible;\nusable if you don't invoke certain features.")]),e._v(" "),a("p",[e._v("The same is true for NPM packages that use missing globals, or attempt to modify frozen primordials.")]),e._v(" "),a("p",[e._v("The "),a("a",{attrs:{href:"https://github.com/endojs/endo/wiki",target:"_blank",rel:"noopener noreferrer"}},[e._v("Endo wiki"),a("OutboundLink")],1),e._v(" tracks compatibility reports for NPM packages,\nincluding potential workarounds.")]),e._v(" "),a("h2",{attrs:{id:"html-comments"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#html-comments"}},[e._v("#")]),e._v(" HTML comments")]),e._v(" "),a("p",[e._v("JavaScript parsers may not recognize HTML comments within source code, potentially causing different\nbehavior on different engines. For safety, the Agoric SES shim rejects any source code containing a comment\nopen ("),a("code",[e._v("\x3c!--")]),e._v(") or close ("),a("code",[e._v("--\x3e")]),e._v(") sequence. However, its filter uses a regular expression, not a full\nparser. It unnecessarily rejects any source code containing either of the strings "),a("code",[e._v("\x3c!--")]),e._v(" or "),a("code",[e._v("--\x3e")]),e._v(",\neven if neither marks a comment.")]),e._v(" "),a("h3",{attrs:{id:"dynamic-import-expressions"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#dynamic-import-expressions"}},[e._v("#")]),e._v(" Dynamic import expressions")]),e._v(" "),a("p",[e._v('The "dynamic import expression" ('),a("code",[e._v("import('path')")]),e._v(") enables code to load dependencies at\nruntime. It returns a promise resolving to the module namespace object. While it takes\nthe form of a function call, it's actually not a function call, but is instead JavaScript\nsyntax. As such it would let vat code bypass the shim's "),a("code",[e._v("Compartment")]),e._v("'s module map.\nFor safety, the SES shim rejects code that looks like it uses a dynamic import expression.")]),e._v(" "),a("p",[e._v("The regular expression for this pattern is safe and should never allow any use of\ndynamic import, however obfuscated the usage is. Because of this, it may be confused\ninto falsely rejecting legitimate code.")]),e._v(" "),a("p",[e._v("For example, the word “import” near a parenthesis or at the end of a line inside a\ncomment is identified as a disallowed use of "),a("code",[e._v("import()")]),e._v(" and falsely rejected:")]),e._v(" "),a("div",{staticClass:"language-js extra-class"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[e._v("//")]),e._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[e._v("// This function calculates the import")]),e._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[e._v("// duties paid on the merchandise..")]),e._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[e._v("//")]),e._v("\n")])])]),a("p",[e._v("But the following obfuscated dynamic import usage is rightly rejected:")]),e._v(" "),a("div",{staticClass:"language-js extra-class"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[e._v("sneaky "),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("import")]),e._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[e._v("// comment to hide invocation")]),e._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),e._v("modulename"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n")])])]),a("h2",{attrs:{id:"direct-vs-indirect-eval-expressions"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#direct-vs-indirect-eval-expressions"}},[e._v("#")]),e._v(" Direct vs. indirect eval expressions")]),e._v(" "),a("p",[e._v("A "),a("em",[e._v("direct eval")]),e._v(", invoked as "),a("code",[e._v("eval(code)")]),e._v(", behaves as if "),a("code",[e._v("code")]),e._v(" were expanded in place. The\nevaluated code sees the same scope as the "),a("code",[e._v("eval")]),e._v(" itself sees, so this "),a("code",[e._v("code")]),e._v(" can reference "),a("code",[e._v("x")]),e._v(":")]),e._v(" "),a("div",{staticClass:"language-js extra-class"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("function")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[e._v("foo")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),a("span",{pre:!0,attrs:{class:"token parameter"}},[e._v("code")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("const")]),e._v(" x "),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[e._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n  "),a("span",{pre:!0,attrs:{class:"token function"}},[e._v("eval")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),e._v("code"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),e._v("\n")])])]),a("p",[e._v("If you perform a direct eval, you cannot hide your internal authorities from the code being evaluated.")]),e._v(" "),a("p",[e._v("In contrast, an "),a("em",[e._v("indirect eval")]),e._v(" only gets the global scope, not the local scope. In a hardened\nenvironment, indirect eval is a useful and common tool. The evaluated code can only access global\nobjects, and those are all safe (and frozen). The only bad thing an indirect eval can do is consume\nunbounded CPU or memory. Once you've evaluated the code, you can invoke it with arguments to give it\nas many or as few authorities as you like.")]),e._v(" "),a("p",[e._v("The most common way to invoke an indirect eval is "),a("code",[e._v("(1,eval)(code)")]),e._v(".")]),e._v(" "),a("p",[e._v("The Hardened JavaScript proposal does not change how direct and indirect eval work. However, the SES shim\ncannot correctly emulate a direct eval. If it tried, it would perform an indirect eval.\nThis could be pretty confusing, because the evaluated code would not use objects from\nthe local scope as expected. Furthermore, in the future when Hardened JavaScript is natively implemented\nby JavaScript engines, the behavior would revert to direct eval, allowing access to\nanything in scope.")]),e._v(" "),a("p",[e._v("To avoid this confusion and compatibility risk, the shim uses a regular expression to\nreject code that looks like it is performing a direct eval. This regexp is not complete\n(you can trick it into allowing a direct eval), but that’s safe because it really performs\nan indirect eval. Our goal is just to guide people away from confusing and non-compliant\nbehaviors early in their development process.")]),e._v(" "),a("p",[e._v("This regexp falsely rejects occurrences inside static strings and comments.")])])}),[],!1,null,null,null);t.default=s.exports}}]);