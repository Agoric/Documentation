(window.webpackJsonp=window.webpackJsonp||[]).push([[54],{454:function(e,t,s){"use strict";s.r(t);var a=s(44),n=Object(a.a)({},(function(){var e=this,t=e.$createElement,s=e._self._c||t;return s("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[s("h1",{attrs:{id:"lockdown-and-its-options"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#lockdown-and-its-options"}},[e._v("#")]),e._v(" "),s("code",[e._v("lockdown()")]),e._v(" and its Options")]),e._v(" "),s("p",[s("strong",[e._v("Note: This document is a companion to the "),s("RouterLink",{attrs:{to:"/guides/js-programming/ses/ses-guide.html"}},[e._v("SES-Guide")]),e._v(", in that it explains and gives backgrounds\nto "),s("code",[e._v("lockdown()")]),e._v(" and its options. If you just want to use "),s("code",[e._v("lockdown()")]),e._v(" with minimal explanation,\nplease see "),s("RouterLink",{attrs:{to:"/guides/js-programming/ses/ses-reference.html"}},[e._v("SES-Reference")]),e._v(".")],1)]),e._v(" "),s("p",[e._v("Calling "),s("code",[e._v("lockdown()")]),e._v(" turns a JavaScript system into a SES (Secure ECMAScript) system,\nwith enforced "),s("em",[e._v("OCap (object-capability) security")]),e._v(". This page documents "),s("code",[e._v("lockdown()")]),e._v(" and its\nconfiguration options.")]),e._v(" "),s("p",[s("code",[e._v("lockdown()")]),e._v(" alters the surrounding execution environment, or "),s("em",[e._v("realm")]),e._v(", such that no two programs\nrunning in the same realm can observe or interfere with each other until they have been introduced.")]),e._v(" "),s("p",[e._v("To do this, "),s("code",[e._v("lockdown()")]),e._v(" tamper-proofs all of the JavaScript intrinsics to prevent prototype pollution.\nAfter that, no program can subvert the methods of these objects (preventing some man in the middle\nattacks). Also, no program can use these mutable objects to pass notes to parties that haven't been\nexpressly introduced (preventing some covert communication channels).")]),e._v(" "),s("p",[e._v("Lockdown freezes all JavaScript defined objects accessible to any program in the realm. The frozen\naccessible objects include but are not limited to:")]),e._v(" "),s("ul",[s("li",[s("code",[e._v("globalThis")])]),e._v(" "),s("li",[s("code",[e._v("[].__proto__")]),e._v(" the array prototype, equivalent to Array.prototype in a pristine JavaScript environment.")]),e._v(" "),s("li",[s("code",[e._v("{}.__proto__")]),e._v(" the Object.prototype")]),e._v(" "),s("li",[s("code",[e._v("(() => {}).__proto__")]),e._v(" the Function.prototype")]),e._v(" "),s("li",[e._v("(async () => {})."),s("strong",[e._v("proto")]),e._v("` the prototype of all asynchronous functions, and has no alias in the global scope of a pristine JavaScript environment")]),e._v(" "),s("li",[e._v("The properties of any accessible object")])]),e._v(" "),s("p",[s("code",[e._v("lockdown()")]),e._v(" also "),s("em",[e._v("tames")]),e._v(" some objects, such as:")]),e._v(" "),s("ul",[s("li",[e._v("Regular expressions\n"),s("ul",[s("li",[e._v("A tamed RexExp does not have the deprecated compile method.")])])]),e._v(" "),s("li",[e._v("Locale methods\n"),s("ul",[s("li",[e._v("Lockdown replaces locale methods like "),s("code",[e._v("String.prototype.localeCompare()")]),e._v(" with lexical\nversions that do not reveal the user locale.")])])]),e._v(" "),s("li",[e._v("Errors\n"),s("ul",[s("li",[e._v("A tamed error does not have a V8 stack, but the console can still see the stack.\nLockdown replaces locale methods like")])])])]),e._v(" "),s("div",{staticClass:"language-js extra-class"},[s("pre",{pre:!0,attrs:{class:"language-js"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("import")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[e._v("'ses'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("import")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[e._v("'my-vetted-shim'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n\n"),s("span",{pre:!0,attrs:{class:"token function"}},[e._v("lockdown")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n\nconsole"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[e._v("log")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),e._v("Object"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[e._v("isFrozen")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("[")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),e._v("__proto__"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("// true")]),e._v("\n")])])]),s("p",[e._v("Lockdown does not erase any powerful objects from the initial global scope. Instead,\nCompartments give complete control over what powerful objects exist for client code.")]),e._v(" "),s("h2",{attrs:{id:"lockdown-vs-harden"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#lockdown-vs-harden"}},[e._v("#")]),e._v(" "),s("code",[e._v("lockdown()")]),e._v(" vs. "),s("code",[e._v("harden()")])]),e._v(" "),s("p",[s("code",[e._v("lockdown()")]),e._v(" and "),s("code",[e._v("harden()")]),e._v(" essentially do the same thing; freeze objects so their\nproperties cannot be changed. The only way to interact with frozen objects is through\ntheir methods. Their differences are what objects you use them on, and when you use them.")]),e._v(" "),s("p",[s("code",[e._v("lockdown()")]),e._v(" "),s("strong",[e._v("must")]),e._v(" be called first. It hardens JavaScript's built-in "),s("em",[e._v("primordials")]),e._v("\n(implicitly shared global objects) and enables "),s("code",[e._v("harden()")]),e._v(". If you call "),s("code",[e._v("harden()")]),e._v("\nbefore "),s("code",[e._v("lockdown()")]),e._v(" executes, it throws an error.")]),e._v(" "),s("p",[s("code",[e._v("lockdown()")]),e._v(" works on objects created by the JavaScript language itself as part of\nits definition. Use "),s("code",[e._v("harden()")]),e._v(" to freeze objects created after "),s("code",[e._v("lockdown()")]),e._v("was called;\ni.e. objects created by programs written in JavaScript.")]),e._v(" "),s("h2",{attrs:{id:"lockdown-options"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#lockdown-options"}},[e._v("#")]),e._v(" "),s("code",[e._v("lockdown")]),e._v(" Options")]),e._v(" "),s("h3",{attrs:{id:"default-safe-settings"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#default-safe-settings"}},[e._v("#")]),e._v(" Default "),s("code",[e._v("safe")]),e._v(" settings")]),e._v(" "),s("p",[e._v("All four of these safety-relevant options default to "),s("code",[e._v("'safe'")]),e._v(" if omitted\nfrom a call to "),s("code",[e._v("lockdown()")]),e._v(". Their other possible value is "),s("code",[e._v("'unsafe'")]),e._v(".")]),e._v(" "),s("ul",[s("li",[s("code",[e._v("regExpTaming")])]),e._v(" "),s("li",[s("code",[e._v("localeTaming")])]),e._v(" "),s("li",[s("code",[e._v("consoleTaming")])]),e._v(" "),s("li",[s("code",[e._v("errorTaming")])])]),e._v(" "),s("p",[e._v("The tradeoff is safety vs compatibility with existing code. However, much legacy\nJavaScript code does run under SES, even if both not written to do so and with all\nthe options set to "),s("code",[e._v("'safe'")]),e._v(". Only consider an "),s("code",[e._v("'unsafe'")]),e._v(" value if you both need it\nand can evaluate its risks. These are described in more detail below.")]),e._v(" "),s("h3",{attrs:{id:"options-quick-reference"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#options-quick-reference"}},[e._v("#")]),e._v(" Options quick reference")]),e._v(" "),s("p",[e._v("This section provides a quick usage reference for lockdown's options, their possible\nvalues, and their usage. Each is described in more detail in their individual sections\nbelow.")]),e._v(" "),s("table",[s("tbody",[s("tr",[s("td",[s("b",[e._v("Option")])]),e._v(" "),s("td",[s("b",[e._v("Values")])]),e._v(" "),s("td",[s("center",[s("b",[e._v("Functionality")])])],1)]),e._v(" "),s("tr",[s("td",[s("code",[e._v("regExpTaming")])]),e._v(" "),s("td",[s("code",[e._v("'safe'")]),e._v(" (default) or "),s("code",[e._v("'unsafe'")])]),e._v(" "),s("td",[s("code",[e._v("'safe'")]),e._v(" disables all "),s("code",[e._v("RegExp.*")]),e._v(" methods,"),s("br"),e._v(" "),s("code",[e._v("'unsafe'")]),e._v(" disables all but "),s("code",[e._v("RegExp.prototype.compile()")])])]),e._v(" "),s("tr",[s("td",[s("code",[e._v("localeTaming")])]),e._v(" "),s("td",[s("code",[e._v("'safe'")]),e._v(" (default) or "),s("code",[e._v("'unsafe'")])]),e._v(" "),s("td",[s("code",[e._v("'safe'")]),e._v(" aliases "),s("code",[e._v("toLocaleString()")]),e._v(" to "),s("code",[e._v("toString()")]),e._v(", etc.,"),s("br"),e._v(" "),s("code",[e._v("'unsafe'")]),e._v(" keeps JavaScript locale methods as is")])]),e._v(" "),s("tr",[s("td",[s("code",[e._v("consoleTaming")])]),e._v(" "),s("td",[s("code",[e._v("'safe'")]),e._v(" (default) or "),s("code",[e._v("'unsafe'")])]),e._v(" "),s("td",[s("code",[e._v("'safe'")]),e._v(" wraps start console to show deep stacks,"),s("br"),e._v(" "),s("code",[e._v("'unsafe'")]),e._v(" uses the original start console.")])]),e._v(" "),s("tr",[s("td",[s("code",[e._v("errorTaming")])]),e._v(" "),s("td",[s("code",[e._v("'safe'")]),e._v(" (default) or "),s("code",[e._v("'unsafe'")])]),e._v(" "),s("td",[s("code",[e._v("'safe'")]),e._v(" denies unprivileged stacks access,"),s("br"),e._v(" "),s("code",[e._v("'unsafe'")]),e._v(" makes stacks also available by "),s("code",[e._v("errorInstance.stackkeeps()")]),e._v(".")])]),e._v(" "),s("tr",[s("td",[s("code",[e._v("stackFiltering")])]),e._v(" "),s("td",[s("code",[e._v("'concise'")]),e._v(" (default) or "),s("code",[e._v("'verbose'")])]),e._v(" "),s("td",[s("code",[e._v("'concise'")]),e._v(" preserves important deep stack info,"),s("br"),e._v(" "),s("code",[e._v("'verbose'")]),e._v(" console shows full deep stacks")])]),e._v(" "),s("tr",[s("td",[s("code",[e._v("overrideTaming")])]),e._v(" "),s("td",[s("code",[e._v("'moderate'")]),e._v(" (default) or "),s("code",[e._v("'min'")])]),e._v(" "),s("td",[s("code",[e._v("'moderate'")]),e._v(" moderates mitigations for legacy compatibility,"),s("br"),e._v(" "),s("code",[e._v("'min'")]),e._v(" minimal mitigations for purely modern code")])])])]),e._v(" "),s("h2",{attrs:{id:"regexptaming-options"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#regexptaming-options"}},[e._v("#")]),e._v(" "),s("code",[e._v("regExpTaming")]),e._v(" Options")]),e._v(" "),s("div",{staticClass:"language-js extra-class"},[s("pre",{pre:!0,attrs:{class:"language-js"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[e._v("lockdown")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("// regExpTaming defaults to 'safe'")]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("// or")]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[e._v("lockdown")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v(" regExpTaming"),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[e._v("'safe'")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("// Disables all RegExp.*() methods.")]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("// vs")]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[e._v("lockdown")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v(" regExpTaming"),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[e._v("'unsafe'")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("// Disables all RegExp.*() methods except RegExp.prototype.compile()")]),e._v("\n")])])]),s("h3",{attrs:{id:"purpose"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#purpose"}},[e._v("#")]),e._v(" Purpose")]),e._v(" "),s("p",[e._v("With its default "),s("code",[e._v("'safe'")]),e._v(" value, "),s("code",[e._v("regExpTaming")]),e._v(" prevents using "),s("code",[e._v("RegExp.*()")]),e._v(" methods in\nthe locked down code.")]),e._v(" "),s("p",[e._v("With its "),s("code",[e._v("'unsafe'")]),e._v(" value, "),s("code",[e._v("RegExp.prototype.compile()")]),e._v(" can be used in locked down code.\nHowever, all other "),s("code",[e._v("RegExp.*()")]),e._v(" methods are disabled")]),e._v(" "),s("h3",{attrs:{id:"background"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#background"}},[e._v("#")]),e._v(" Background")]),e._v(" "),s("p",[e._v("There are two reasons for removing "),s("code",[e._v("RegExp.*")]),e._v(" methods from usable JavaScript.\nOne is for "),s("code",[e._v("RegExp.prototype.compile()")]),e._v(" and one for all other "),s("code",[e._v("RegExp.*()")]),e._v(" methods.")]),e._v(" "),s("ul",[s("li",[s("p",[e._v("In standard JavaScript, "),s("code",[e._v("RegExp.prototype.compile()")]),e._v(" may\nviolate the object invariants of frozen "),s("code",[e._v("RegExp")]),e._v(" instances. This violates\nassumptions elsewhere, and so can corrupt other guarantees. For example,\nthe "),s("code",[e._v("Proxy")]),e._v(" abstraction preserves the object invariants only if its target\ndoes. If a non-conforming object is available, it can construct an also\nnon-conforming proxy object.")]),e._v(" "),s("p",[e._v("The default "),s("code",[e._v("'safe'")]),e._v(" setting deletes this dangerous method. The\n"),s("code",[e._v("'unsafe'")]),e._v(" setting keeps it for compatibility purposes at the price of riskier code.")])]),e._v(" "),s("li",[s("p",[e._v("In standard JavaScript, legacy "),s("code",[e._v("RegExp")]),e._v(" static methods like "),s("code",[e._v("RegExp.lastMatch()")]),e._v("\nare an unsafe global "),s("a",{attrs:{href:"https://agoric.com/taxonomy-of-security-issues/",target:"_blank",rel:"noopener noreferrer"}},[e._v("overt communications channel"),s("OutboundLink")],1),e._v(".\nThe "),s("code",[e._v("RegExp")]),e._v(" constructor reveals information derived from the last match\nmade by any "),s("code",[e._v("RegExp")]),e._v(" instance in a form of non-local causality.")]),e._v(" "),s("p",[e._v("Except for "),s("code",[e._v("RegExp.prototype.compile()")]),e._v(" all "),s("code",[e._v("RegExp")]),e._v(" static methods are currently\nremoved under "),s("strong",[e._v("both")]),e._v(" the "),s("code",[e._v("regExpTaming")]),e._v(" "),s("code",[e._v("'safe")]),e._v("' and "),s("code",[e._v("'unsafe'")]),e._v(" settings. This\nhas not caused any compatibility problems; if it does, we may allow a subset\nunder the "),s("code",[e._v("'unsafe'")]),e._v(" setting.")])])]),e._v(" "),s("h2",{attrs:{id:"localetaming-options"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#localetaming-options"}},[e._v("#")]),e._v(" "),s("code",[e._v("localeTaming")]),e._v(" Options")]),e._v(" "),s("div",{staticClass:"language-js extra-class"},[s("pre",{pre:!0,attrs:{class:"language-js"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[e._v("lockdown")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("// localeTaming defaults to 'safe'")]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("// or")]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[e._v("lockdown")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v(" localeTaming"),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[e._v("'safe'")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("// Alias toLocaleString to toString, etc")]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("// vs")]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[e._v("lockdown")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v(" localeTaming"),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[e._v("'unsafe'")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("// Allow locale-specific behavior")]),e._v("\n")])])]),s("h3",{attrs:{id:"purpose-2"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#purpose-2"}},[e._v("#")]),e._v(" Purpose")]),e._v(" "),s("p",[e._v("The default "),s("code",[e._v("'safe'")]),e._v(" setting replaces each method listed below with their\ncorresponding non-locale-specific method. For example, "),s("code",[e._v("Object.prototype.toLocaleString()")]),e._v("\nbecomes another name for "),s("code",[e._v("Object.prototype.toString()")]),e._v(".")]),e._v(" "),s("p",[e._v("The "),s("code",[e._v("'unsafe'")]),e._v(" setting keeps the original behavior for compatibility at the price\nof reproducibility and fingerprinting.")]),e._v(" "),s("p",[e._v("In standard JavaScript, these built-in methods have "),s("code",[e._v("Locale")]),e._v(" or "),s("code",[e._v("locale")]),e._v(" in their name\nand are affected by "),s("code",[e._v("localeTaming")]),e._v(":")]),e._v(" "),s("ul",[s("li",[s("code",[e._v("toLocaleString")])]),e._v(" "),s("li",[s("code",[e._v("toLocaleDateString")])]),e._v(" "),s("li",[s("code",[e._v("toLocaleTimeString")])]),e._v(" "),s("li",[s("code",[e._v("toLocaleLowerCase")])]),e._v(" "),s("li",[s("code",[e._v("toLocaleUpperCase")])]),e._v(" "),s("li",[s("code",[e._v("localeCompare")])])]),e._v(" "),s("h3",{attrs:{id:"background-2"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#background-2"}},[e._v("#")]),e._v(" Background")]),e._v(" "),s("p",[e._v("All \"locale method\" behavior varies depending on the user's locale and can change while\na program is running. This breaks determinism since a program run in one compartment may have\na different result in another compartment or at another time. Also, revealing the user's locale"),s("br"),e._v("\nhelps unscrupulous programs to track and even identify the user.")]),e._v(" "),s("p",[e._v('This behavior might be acceptable if governed on a per-compartment basis ("virtualized").\nBut since these methods appear on the prototype of shared intrinsic objects like the '),s("code",[e._v("String")]),e._v("\nprototype, there is no safe alternative design.")]),e._v(" "),s("p",[e._v("Instead, the hosting program can reveal the locale to all compartments by setting\n"),s("code",[e._v("localeTaming")]),e._v(" to "),s("code",[e._v("'unsafe'")]),e._v(", or inject a "),s("code",[e._v("locale")]),e._v(" object into selected compartments\nwith the powers of these methods.")]),e._v(" "),s("p",[e._v("Aside from fingerprinting, the risk that this slow non-determinism opens a\n"),s("a",{attrs:{href:"https://agoric.com/taxonomy-of-security-issues/",target:"_blank",rel:"noopener noreferrer"}},[e._v("communications channel"),s("OutboundLink")],1),e._v("\nis negligible.")]),e._v(" "),s("h2",{attrs:{id:"consoletaming-options"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#consoletaming-options"}},[e._v("#")]),e._v(" "),s("code",[e._v("consoleTaming")]),e._v(" Options")]),e._v(" "),s("div",{staticClass:"language-js extra-class"},[s("pre",{pre:!0,attrs:{class:"language-js"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[e._v("lockdown")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("// consoleTaming defaults to 'safe'")]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("// or")]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[e._v("lockdown")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v(" consoleTaming"),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[e._v("'safe'")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("// Wrap start console to show deep stacks")]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("// vs")]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[e._v("lockdown")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v(" consoleTaming"),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[e._v("'unsafe'")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("// Leave original start console in place")]),e._v("\n")])])]),s("h3",{attrs:{id:"purpose-3"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#purpose-3"}},[e._v("#")]),e._v(" Purpose")]),e._v(" "),s("p",[e._v("The "),s("code",[e._v("'unsafe'")]),e._v(" setting leaves the original console in place. The "),s("code",[e._v("assert")]),e._v(" package\nand error objects continue to work, but the "),s("code",[e._v("console")]),e._v(" logging output will not\nshow this extra information.")]),e._v(" "),s("h3",{attrs:{id:"background-3"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#background-3"}},[e._v("#")]),e._v(" Background")]),e._v(" "),s("p",[e._v("Most JavaScript environments provide a write-only "),s("code",[e._v("console")]),e._v(" object on the\nglobal object. JavaScript code can write to the console's logging output, but\ncannot see that output. The logging output is normally meant for humans, and\nis mostly formatted for human use for diagnosing problems.")]),e._v(" "),s("p",[e._v("Given these constraints, it is safe and helpful for "),s("code",[e._v("console")]),e._v(" to reveal\nto humans information it would not reveal to objects it interacts with.\nSES amplifies this and reveals much more information than the normal\n"),s("code",[e._v("console")]),e._v(" does. By default and during "),s("code",[e._v("lockdown")]),e._v(" SES replaces the built-in\n"),s("code",[e._v("console")]),e._v(" with a wrapper, thus virtualizing it.")]),e._v(" "),s("p",[e._v("Also, the enhanced virtual "),s("code",[e._v("console")]),e._v(" has a special relationship with\nerror objects and the SES "),s("code",[e._v("assert")]),e._v(" package. Errors can report\nmore diagnostic information that should be hidden from other objects. See\nthe "),s("a",{attrs:{href:"https://github.com/endojs/endo/blob/master/packages/ses/src/error/README.md",target:"_blank",rel:"noopener noreferrer"}},[e._v("error README"),s("OutboundLink")],1),e._v("\nfor an in depth explanation of this\nrelationship between errors, "),s("code",[e._v("assert")]),e._v(" and the virtual "),s("code",[e._v("console")]),e._v(".")]),e._v(" "),s("p",[s("code",[e._v("console")]),e._v(' often has additional methods beyond its de facto "standards". The\n'),s("code",[e._v("'unsafe'")]),e._v(" setting does not remove them. We do not know if these additional\nmethods violate OCap security, so should assume they are unsafe. A raw "),s("code",[e._v("console")]),e._v("\nobject should only be handled by very trustworthy code.")]),e._v(" "),s("p",[e._v("Examples from\n"),s("a",{attrs:{href:"https://github.com/Agoric/agoric-sdk/blob/master/packages/eventual-send/test/test-deep-send.js",target:"_blank",rel:"noopener noreferrer"}},[e._v("test-deep-send.js"),s("OutboundLink")],1),e._v("\nof the eventual-send shim:")]),e._v(" "),s("details",[s("summary",[e._v("Expand for { consoleTaming: 'safe' } log output")]),e._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",[s("code",[e._v("expected failure (Error#1)\nNested error\n  Error#1: Wut?\n    at Object.bar (packages/eventual-send/test/test-deep-send.js:13:21)\n\n  Error#1 ERROR_NOTE: Thrown from: (Error#2) : 2 . 0\n  Error#1 ERROR_NOTE: Rejection from: (Error#3) : 1 . 1\n  Nested 2 errors under Error#1\n    Error#2: Event: 1.1\n      at Object.foo (packages/eventual-send/test/test-deep-send.js:17:28)\n\n    Error#2 ERROR_NOTE: Caused by: (Error#3)\n    Nested error under Error#2\n      Error#3: Event: 0.1\n        at Object.test (packages/eventual-send/test/test-deep-send.js:21:22)\n        at packages/eventual-send/test/test-deep-send.js:25:19\n        at async Promise.all (index 0)\n")])])])]),e._v(" "),s("details",[s("summary",[e._v("Expand for { consoleTaming: 'unsafe', overrideTaming: 'min' } log output")]),e._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",[s("code",[e._v("expected failure [Error: Wut?\n  at Object.bar (packages/eventual-send/test/test-deep-send.js:13:21)]\n")])])])]),e._v(" "),s("h2",{attrs:{id:"errortaming-options"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#errortaming-options"}},[e._v("#")]),e._v(" "),s("code",[e._v("errorTaming")]),e._v(" Options")]),e._v(" "),s("div",{staticClass:"language-js extra-class"},[s("pre",{pre:!0,attrs:{class:"language-js"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[e._v("lockdown")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("// errorTaming defaults to 'safe'")]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("// or")]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[e._v("lockdown")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v(" errorTaming"),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[e._v("'safe'")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("// Deny unprivileged access to stacks, if possible")]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("// vs")]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[e._v("lockdown")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v(" errorTaming"),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[e._v("'unsafe'")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("// Stacks also available by errorInstance.stack")]),e._v("\n")])])]),s("h2",{attrs:{id:"purpose-4"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#purpose-4"}},[e._v("#")]),e._v(" Purpose")]),e._v(" "),s("p",[e._v("The "),s("code",[e._v("errorTaming")]),e._v(" default "),s("code",[e._v("'safe'")]),e._v(" setting makes the stack trace inaccessible\nfrom error instances alone. It does this on v8 (Chrome, Brave, Node) and SpiderMonkey (Firefox).\nNote that it is "),s("strong",[e._v("not")]),e._v(" hidden on other engines, leaving an information\nleak available. It reveals information only as a powerless\nstring. It threatens "),s("a",{attrs:{href:"https://agoric.com/taxonomy-of-security-issues/",target:"_blank",rel:"noopener noreferrer"}},[e._v("confidentiality but not integrity"),s("OutboundLink")],1),e._v(".")]),e._v(" "),s("p",[e._v("In JavaScript the stack is only available via "),s("code",[e._v("err.stack")]),e._v(", so some\ndevelopment tools assume it is there. When the information leak is tolerable,\nthe "),s("code",[e._v("'unsafe'")]),e._v(" setting preserves "),s("code",[e._v("err.stack")]),e._v("'s filtered stack information.")]),e._v(" "),s("h3",{attrs:{id:"background-4"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#background-4"}},[e._v("#")]),e._v(" Background")]),e._v(" "),s("p",[e._v("JavaScript's error system has several safety problems.\nIn most JavaScript engines running normal JavaScript, if "),s("code",[e._v("err")]),e._v(" is an\nError instance, the expression "),s("code",[e._v("err.stack")]),e._v(" produces a string that\nreveals the stack trace. This is an "),s("a",{attrs:{href:"https://agoric.com/taxonomy-of-security-issues/",target:"_blank",rel:"noopener noreferrer"}},[e._v("overt information leak, a confidentiality\nviolation"),s("OutboundLink")],1),e._v(".\nThis "),s("code",[e._v("stack")]),e._v(" property reveals call stack information that violates\nthe callers' encapsulation.")]),e._v(" "),s("p",[e._v("This "),s("code",[e._v("stack")]),e._v(" is part of de facto JavaScript, but not part\nof the official standard. It is proposed at\n"),s("a",{attrs:{href:"https://github.com/tc39/proposal-error-stacks",target:"_blank",rel:"noopener noreferrer"}},[e._v("Error Stacks proposal"),s("OutboundLink")],1),e._v(".")]),e._v(" "),s("p",[e._v("On v8—the JavaScript engine powering Chrome, Brave, and Node—the\ndefault error behavior is dangerous. The v8 "),s("code",[e._v("Error")]),e._v(" constructor\nprovides a set of "),s("a",{attrs:{href:"https://v8.dev/docs/stack-trace-api",target:"_blank",rel:"noopener noreferrer"}},[e._v("static methods for accessing the raw stack\ninformation"),s("OutboundLink")],1),e._v(" that create\nthe error stack string.")]),e._v(" "),s("p",[s("code",[e._v("errorTaming")]),e._v(" does not affect the "),s("code",[e._v("Error")]),e._v(" constructor's safety.\nAfter calling "),s("code",[e._v("lockdown")]),e._v(", the tamed "),s("code",[e._v("Error")]),e._v(" constructor in the\nstart compartment follows OCap rules. Under v8 it emulates most of the\nmagic powers of the v8 "),s("code",[e._v("Error")]),e._v(" constructor—those consistent with the\ndiscourse level of the proposed "),s("code",[e._v("getStack")]),e._v(". In all cases, the "),s("code",[e._v("Error")]),e._v("\nconstructor shared by all other compartments is both safe and powerless.")]),e._v(" "),s("p",[e._v("See the "),s("a",{attrs:{href:"https://github.com/endojs/endo/blob/master/packages/ses/src/error/README.md",target:"_blank",rel:"noopener noreferrer"}},[e._v("error README"),s("OutboundLink")],1),e._v("\nfor an in depth explanation of the\nrelationship between errors, "),s("code",[e._v("assert")]),e._v(" and the virtual "),s("code",[e._v("console")]),e._v(".")]),e._v(" "),s("h2",{attrs:{id:"stackfiltering-options"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#stackfiltering-options"}},[e._v("#")]),e._v(" "),s("code",[e._v("stackFiltering")]),e._v(" Options")]),e._v(" "),s("div",{staticClass:"language-js extra-class"},[s("pre",{pre:!0,attrs:{class:"language-js"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[e._v("lockdown")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("// stackFiltering defaults to 'concise'")]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("// or")]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[e._v("lockdown")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v(" stackFiltering"),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[e._v("'concise'")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("// Preserve important deep stack info")]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("// vs")]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[e._v("lockdown")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v(" stackFiltering"),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[e._v("'verbose'")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("// Console shows full deep stacks")]),e._v("\n")])])]),s("h3",{attrs:{id:"purpose-5"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#purpose-5"}},[e._v("#")]),e._v(" Purpose")]),e._v(" "),s("p",[s("code",[e._v("stackFiltering")]),e._v(" trades off stronger stack traceback filtering to\nminimize distractions vs completeness for tracking down bugs in\nobscure places.")]),e._v(" "),s("h3",{attrs:{id:"background-5"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#background-5"}},[e._v("#")]),e._v(" Background")]),e._v(" "),s("p",[e._v("Many JavaScript engines show voluminous error stacks, containing many stack\nframes of infrastructure functions which are usually irrelevant for bug diagnosis.\nThe SES-shim's "),s("code",[e._v("console")]),e._v(", with "),s("code",[e._v("consoleTaming")]),e._v(" set to "),s("code",[e._v("'safe'")]),e._v(', is even more\nvoluminous. It displays "deep stack" traces, tracing back through the\n'),s("a",{attrs:{href:"https://github.com/tc39/proposal-eventual-send",target:"_blank",rel:"noopener noreferrer"}},[e._v("eventually sent messages"),s("OutboundLink")],1),e._v("\nfrom other turns of the event loop.")]),e._v(" "),s("p",[e._v("Full deep distributed stacks are overwhelmingly noisy for debugging distributed\ncomputation. When possible, the SES-shim filters and transforms the shown stack\ntrace information, removing artifacts from low level infrastructure.\nCurrently, this only works on v8.")]),e._v(" "),s("p",[e._v("The 'concise' vs 'verbose' settings are about trying to reduce the noise appearing\non the console's reported stack traces.\nThe default "),s("code",[e._v("'concise'")]),e._v(" setting reduces the noise. But it does so at the risk of\nthrowing out the signal you were really looking for. Sometimes bugs might be in\nthat infrastructure, so that information is relevant. With the "),s("code",[e._v("'verbose'")]),e._v(" setting,\nthe console shows the full raw stack information for each level of the deep stacks.")]),e._v(" "),s("p",[e._v("Either "),s("code",[e._v("stackFiltering")]),e._v(" setting is safe. Stack information will\nor will not be available from error objects according to the "),s("code",[e._v("errorTaming")]),e._v("\noption and the platform error behavior.")]),e._v(" "),s("p",[e._v("Examples from\n"),s("a",{attrs:{href:"https://github.com/Agoric/agoric-sdk/blob/master/packages/eventual-send/test/test-deep-send.js",target:"_blank",rel:"noopener noreferrer"}},[e._v("test-deep-send.js"),s("OutboundLink")],1),e._v("\nof the eventual-send shim:\n")]),s("details",[s("summary",[e._v("Expand for { stackFiltering: 'concise' } log output")]),s("p"),e._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",[s("code",[e._v("expected failure (Error#1)\nNested error\n  Error#1: Wut?\n    at Object.bar (packages/eventual-send/test/test-deep-send.js:13:21)\n\n  Error#1 ERROR_NOTE: Thrown from: (Error#2) : 2 . 0\n  Error#1 ERROR_NOTE: Rejection from: (Error#3) : 1 . 1\n  Nested 2 errors under Error#1\n    Error#2: Event: 1.1\n      at Object.foo (packages/eventual-send/test/test-deep-send.js:17:28)\n\n    Error#2 ERROR_NOTE: Caused by: (Error#3)\n    Nested error under Error#2\n      Error#3: Event: 0.1\n        at Object.test (packages/eventual-send/test/test-deep-send.js:21:22)\n        at packages/eventual-send/test/test-deep-send.js:25:19\n        at async Promise.all (index 0)\n")])])])]),e._v(" "),s("details",[s("summary",[e._v("Expand for { stackFiltering: 'verbose' } log output")]),e._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",[s("code",[e._v("expected failure (Error#1)\nNested error\n  Error#1: Wut?\n    at makeError (/Users/markmiller/src/ongithub/agoric/agoric-sdk/packages/install-ses/node_modules/ses/dist/ses.cjs:2976:17)\n    at Function.fail (/Users/markmiller/src/ongithub/agoric/agoric-sdk/packages/install-ses/node_modules/ses/dist/ses.cjs:3109:19)\n    at Object.bar (/Users/markmiller/src/ongithub/agoric/agoric-sdk/packages/eventual-send/test/test-deep-send.js:13:21)\n    at /Users/markmiller/src/ongithub/agoric/agoric-sdk/packages/eventual-send/src/index.js:388:23\n    at Object.applyMethod (/Users/markmiller/src/ongithub/agoric/agoric-sdk/packages/eventual-send/src/index.js:353:14)\n    at doIt (/Users/markmiller/src/ongithub/agoric/agoric-sdk/packages/eventual-send/src/index.js:395:67)\n    at /Users/markmiller/src/ongithub/agoric/agoric-sdk/packages/eventual-send/src/track-turns.js:64:22\n    at win (/Users/markmiller/src/ongithub/agoric/agoric-sdk/packages/eventual-send/src/index.js:408:19)\n    at /Users/markmiller/src/ongithub/agoric/agoric-sdk/packages/eventual-send/src/index.js:425:20\n    at processTicksAndRejections (internal/process/task_queues.js:93:5)\n\n  Error#1 ERROR_NOTE: Thrown from: (Error#2) : 2 . 0\n  Error#1 ERROR_NOTE: Rejection from: (Error#3) : 1 . 1\n  Nested 2 errors under Error#1\n    Error#2: Event: 1.1\n      at trackTurns (/Users/markmiller/src/ongithub/agoric/agoric-sdk/packages/eventual-send/src/track-turns.js:47:24)\n      at handle (/Users/markmiller/src/ongithub/agoric/agoric-sdk/packages/eventual-send/src/index.js:396:27)\n      at Function.applyMethod (/Users/markmiller/src/ongithub/agoric/agoric-sdk/packages/eventual-send/src/index.js:312:14)\n      at Proxy.&lt;anonymous&gt; (/Users/markmiller/src/ongithub/agoric/agoric-sdk/packages/eventual-send/src/E.js:37:49)\n      at Object.foo (/Users/markmiller/src/ongithub/agoric/agoric-sdk/packages/eventual-send/test/test-deep-send.js:17:28)\n      at /Users/markmiller/src/ongithub/agoric/agoric-sdk/packages/eventual-send/src/index.js:388:23\n      at Object.applyMethod (/Users/markmiller/src/ongithub/agoric/agoric-sdk/packages/eventual-send/src/index.js:353:14)\n      at doIt (/Users/markmiller/src/ongithub/agoric/agoric-sdk/packages/eventual-send/src/index.js:395:67)\n      at /Users/markmiller/src/ongithub/agoric/agoric-sdk/packages/eventual-send/src/track-turns.js:64:22\n      at win (/Users/markmiller/src/ongithub/agoric/agoric-sdk/packages/eventual-send/src/index.js:408:19)\n      at /Users/markmiller/src/ongithub/agoric/agoric-sdk/packages/eventual-send/src/index.js:425:20\n      at processTicksAndRejections (internal/process/task_queues.js:93:5)\n\n    Error#2 ERROR_NOTE: Caused by: (Error#3)\n    Nested error under Error#2\n      Error#3: Event: 0.1\n        at trackTurns (/Users/markmiller/src/ongithub/agoric/agoric-sdk/packages/eventual-send/src/track-turns.js:47:24)\n        at handle (/Users/markmiller/src/ongithub/agoric/agoric-sdk/packages/eventual-send/src/index.js:396:27)\n        at Function.applyMethod (/Users/markmiller/src/ongithub/agoric/agoric-sdk/packages/eventual-send/src/index.js:312:14)\n        at Proxy.<anonymous> (/Users/markmiller/src/ongithub/agoric/agoric-sdk/packages/eventual-send/src/E.js:37:49)\n        at Object.test (/Users/markmiller/src/ongithub/agoric/agoric-sdk/packages/eventual-send/test/test-deep-send.js:21:22)\n        at /Users/markmiller/src/ongithub/agoric/agoric-sdk/packages/eventual-send/test/test-deep-send.js:25:19\n        at Test.callFn (/Users/markmiller/src/ongithub/agoric/agoric-sdk/node_modules/ava/lib/test.js:610:21)\n        at Test.run (/Users/markmiller/src/ongithub/agoric/agoric-sdk/node_modules/ava/lib/test.js:623:23)\n        at Runner.runSingle (/Users/markmiller/src/ongithub/agoric/agoric-sdk/node_modules/ava/lib/runner.js:280:33)\n        at Runner.runTest (/Users/markmiller/src/ongithub/agoric/agoric-sdk/node_modules/ava/lib/runner.js:348:30)\n        at processTicksAndRejections (internal/process/task_queues.js:93:5)\n        at async Promise.all (index 0)\n        at async /Users/markmiller/src/ongithub/agoric/agoric-sdk/node_modules/ava/lib/runner.js:493:21\n        at async Runner.start (/Users/markmiller/src/ongithub/agoric/agoric-sdk/node_modules/ava/lib/runner.js:503:15)\n")])])])]),e._v(" "),s("h2",{attrs:{id:"overridetaming-options"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#overridetaming-options"}},[e._v("#")]),e._v(" "),s("code",[e._v("overrideTaming")]),e._v(" Options")]),e._v(" "),s("div",{staticClass:"language-js extra-class"},[s("pre",{pre:!0,attrs:{class:"language-js"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[e._v("lockdown")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("// overrideTaming defaults to 'moderate'")]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("// or")]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[e._v("lockdown")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v(" overrideTaming"),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[e._v("'moderate'")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("// Moderate mitigations for legacy compatibility")]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("// vs")]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[e._v("lockdown")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v(" overrideTaming"),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[e._v("'min'")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("// Minimal mitigations for purely modern code")]),e._v("\n")])])]),s("h3",{attrs:{id:"purpose-6"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#purpose-6"}},[e._v("#")]),e._v(" Purpose")]),e._v(" "),s("p",[e._v("The "),s("code",[e._v("overrideTaming")]),e._v(" option trades off better code\ncompatibility vs better tool compatibility.")]),e._v(" "),s("h3",{attrs:{id:"background-6"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#background-6"}},[e._v("#")]),e._v(" Background")]),e._v(" "),s("p",[e._v("JavaScript suffers from the so-called\n"),s("a",{attrs:{href:"https://web.archive.org/web/20141230041441/http://wiki.ecmascript.org/doku.php?id=strawman:fixing_override_mistake",target:"_blank",rel:"noopener noreferrer"}},[e._v("override mistake"),s("OutboundLink")],1),e._v(",\npreventing "),s("code",[e._v("lockdown()")]),e._v(" from "),s("em",[e._v("simply")]),e._v(" hardening all primordials.")]),e._v(" "),s("p",[e._v("Rather, "),s("code",[e._v("lockdown()")]),e._v(" converts each of\n"),s("a",{attrs:{href:"https://github.com/endojs/endo/blob/master/packages/ses/src/enablements.js",target:"_blank",rel:"noopener noreferrer"}},[e._v("these data properties"),s("OutboundLink")],1),e._v(" to an accessor\nproperty whose getter and setter emulate "),s("a",{attrs:{href:"https://github.com/tc39/ecma262/pull/1320",target:"_blank",rel:"noopener noreferrer"}},[e._v("a data property without the override\nmistake"),s("OutboundLink")],1),e._v(". For non-reflective code\nthe illusion is perfect. But reflective code sees it is an accessor\nrather than a data property. We add an "),s("code",[e._v("originalValue")]),e._v(" property to that accessor's\ngetter, letting reflective code know that a getter alleges that it\nresults from this transform, and what the original data value was. This enables\na form of cooperative emulation, where that code can decide whether to uphold\nthe illusion by pretending it sees the data property that would have been there.")]),e._v(" "),s("p",[e._v('The VSCode debugger\'s object inspector shows the own properties of an object,\na great aid to debugging. Unfortunately, it also shows the inherited\naccessor properties, with one line for the getter and another for the\nsetter. As you enable override on more properties of widely used prototypes,\nyou become compatible with more legacy code, but at the price of a significantly\nworse debugging experience. Expand the "Expand for..." items at the end of this\nsection for screenshots showing the different experiences.')]),e._v(" "),s("p",[e._v("Enablements have a further debugging cost. When single stepping "),s("em",[e._v("into")]),e._v(" code,\nyou step into every access to an enabled property. Every read steps into\nthe enabling getter. This adds yet more noise to the debugging experience.")]),e._v(" "),s("p",[s("a",{attrs:{href:"https://github.com/endojs/endo/blob/master/packages/ses/src/enablements.js",target:"_blank",rel:"noopener noreferrer"}},[e._v("src/enablements.js"),s("OutboundLink")],1),e._v(" exports two different\nwhitelists defining which data properties to convert to enable override by\nassignment, "),s("code",[e._v("moderateEnablements")]),e._v(" and "),s("code",[e._v("minEnablements")]),e._v(".")]),e._v(" "),s("p",[e._v("The "),s("code",[e._v("overrideTaming")]),e._v(" default "),s("code",[e._v("'moderate'")]),e._v(" option of "),s("code",[e._v("lockdown")]),e._v(" is intended to\nbe fairly minimal. We expand it when we\nencounter code which should run under SES but can't due to\nthe override mistake. As we encountered these we listed them in the comments\nnext to each enablement. We rarely come\nacross any more cases. "),s("em",[s("strong",[e._v("If you find one, please file an issue.")])])]),e._v(" "),s("p",[e._v("The "),s("code",[e._v("'min'")]),e._v(" enablements setting serves two purposes: it enables a pleasant\ndebugging experience in VSCode, and it helps ensure new code does not\ndepend on anything more than these being enabled.\nAll Agoric-authored is compatible with both settings, but\nAgoric currently still pulls in some third party dependencies only compatible\nwith the "),s("code",[e._v("'moderate'")]),e._v(" setting.")]),e._v(" "),s("p",[e._v("The following screenshots shows inspection of the "),s("code",[e._v("{ abc: 123 }")]),e._v(' object, both\nby hover and in the rightmost "VARIABLES" pane.\nOnly the '),s("code",[e._v("abc")]),e._v(" property is normally useful. All other lines are noise introduced\nby our override mitigation.")]),e._v(" "),s("details",[s("summary",[e._v("Expand for { overrideTaming: 'moderate' } vscode inspector display")]),e._v(" "),s("p",[e._v("![overrideTaming: 'moderate' vscode inspector display](./assets/override-taming-moderate-inspector.png)")])]),e._v(" "),s("details",[s("summary",[e._v("Expand for { overrideTaming: 'min' } vscode inspector display")]),e._v(" "),s("p",[e._v("![overrideTaming: 'min' vscode inspector display](./assets/override-taming-min-inspector.png)")])]),e._v(" "),s("details",[s("summary",[e._v("Expand to see the vscode inspector display if enabling all of Object.prototype")]),e._v(" "),s("p",[e._v("![vscode inspector display if enabling all of Object.prototype](./assets/override-taming-star-inspector.png)")])])])}),[],!1,null,null,null);t.default=n.exports}}]);